---
생성일: 2022-12-26
하위태그:
  - 수업과정
last_modified_at: 2022-12-26
상위태그:
  - 수업과정
category: Spring
tags:
  - spring
  - mvc
  - 국비교육
title: "[국비교육학원-수업내용정리] MVC패턴 실습"
---
클라이언트사이드 렌더링(CSR) : 사용자의 컴퓨터 성능에따라 달라짐. (지금까지 한 방법)

서버사이드 렌더링(SSR) : 서버의 성능에 따라 움직임?(새로 시도할 방법)

  

jdk버전 17.0.4.1로 업데이트함

환경변수 JAVA_HOME 경로 변경해주기. vscode에서도 자바버전 확인해보기

스프링 프로젝트 생성시 자바 3.0.1, 17버전으로 선택

application.properties에서 공백이 들어가면 안됨. 종료를 의미하는 ;을 사용하지 않아서 제대로 써줘야함

  

controller(사용자와의 연결을 관리)에서 날아온 medel을 viewResolver가 파일을 찾아서 view에 표시함

callback(프로그램이 메소드를 실행)개념과도 맞물림 - 자바스크립트의 event, click, spring의 getMapping 등 IOC와 동일함

  

resource의 static폴더에는 아이콘 같이 잘 변하지않는 것들을 넣음

  

- html에서 입력받은 정보를 객체에 저장하는 방법

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>회원가입</h1>
    <form action="/member/join" method="post">
        <table>
            <tbody>
                <tr>
                    <td>아이디</td>
                    <td><input type="text" name="id"></td>
                </tr>
                <tr>
                    <td>비밀번호</td>
                    <td><input type="password" name="pwd"></td>
                </tr>
                <tr>
                    <td>이름(닉네임)</td>
                    <td><input type="text" name="nickname"></td>
                </tr>
                <tr>
                    <td colspan="2">
                        <input type="submit" value="회원가입">
                        <a href="/">메인으로</a>
                    </td>
                </tr>
            </tbody>
        </table>
    </form>
</body>
</html>
```

```java
package com.green.demo.VO;

import lombok.Data;

@Data
public class UserInfoVO {
    private String id;
    private String pwd;
    private String nickname;
}
```

```java
package com.green.demo.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import com.green.demo.VO.UserInfoVO;

@Controller
@RequestMapping("/member")
public class MemberController {
    @GetMapping("/join")
    public String getMemberJoin(){
        return "/member/join";
    }
    @PostMapping("/join")
    public String postMemberJoin(UserInfoVO data){
        System.out.println(data);
        return "member/join";
    }
}
```

![images](/assets/images/green/IMG-20240908160523.png)

여기서 회원가입하면
![images](/assets/images/green/IMG-20240908160524.png)

출력됨

```java
package com.green.demo.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import com.green.demo.VO.UserInfoVO;
import com.green.demo.entity.UserEntity;
import com.green.demo.repository.UserRepository;

@Controller
@RequestMapping("/member")
public class MemberController {
    @Autowired UserRepository uRepo;
    @GetMapping("/join")
    public String getMemberJoin(){
        return "/member/join";
    }
    @PostMapping("/join")
    public String postMemberJoin(UserInfoVO data){
        System.out.println(data);
        UserEntity entity = new UserEntity(null, data.getId(), data.getPwd(), data.getNickname());
        System.out.println(entity);
        uRepo.save(entity);
        return "member/join";
    }
}
```

받은 값은 repository에 save()해주면 DB에 저장됨

물론 이런방법으로 하면 안됨

- 가입 후 성공메세지

```java
@PostMapping("/join")
    public String postMemberJoin(UserInfoVO data){
        System.out.println(data);
        UserEntity entity = new UserEntity(null, data.getId(), data.getPwd(), data.getNickname());
        System.out.println(entity);
        uRepo.save(entity);
        return "member/joined";
    }
```

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>성공적으로 가입되었습니다.</h1>
    <a href="/">메인으로</a>
</body>
</html>
```

- 중복가입 메세지

```java
@PostMapping("/join")
    public String postMemberJoin(UserInfoVO data, Model model){
        System.out.println(data);
        if(uRepo.countByUiId(data.getId())>0){
            model.addAttribute("dup_id", data.getId());
            return "/member/duplicated";
        }
        UserEntity entity = new UserEntity(null, data.getId(), data.getPwd(), data.getNickname());
        System.out.println(entity);
        uRepo.save(entity);
        return "member/joined";
    }
```

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1><u th:text="${dup_id}"></u>은/는 이미 가입된 아이디입니다.</h1>
    <a href="/">메인으로</a>
    <a href="/member/join">회원가입</a>
</body>
</html>
```

---

책

[application.properties](https://application.properties) 설정

```java
server.port=8044
\#DB설정  jdbc:mysql://jdbc연결 프로토콜(http://, ftp://, smtp://)
spring.datasource.url=jdbc:mysql://localhost:3306/book_info_db
spring.datasource.username=root
spring.datasource.password=1234

\#thymeleaf(출력화면) 설정
spring.thymeleaf.enabled=true
\#application.properties입장에서의 소속 패키지(폴더경로)
# classpath : src/main/resources 경로를 의미
spring.thymeleaf.prefix=classpath:/templates/
#최종적으로 src/main/resources/templates/ 경로를 의미
spring.thymeleaf.suffix=.html

\#File Transfer Settings
spring.servlet.multipart.enabled=true
spring.servlet.multipart.max-file-size=100MB
spring.servlet.multipart.max-request-size=110MB
```

- 일부 값만 적어서 객체 생성하는 방법 - @Builder
    
    ```java
    package com.greenart.book_info.entity;
    
    
    
    import org.hibernate.annotations.ColumnDefault;
    import org.hibernate.annotations.DynamicInsert;
    
    import jakarta.persistence.Column;
    import jakarta.persistence.Entity;
    import jakarta.persistence.GeneratedValue;
    import jakarta.persistence.GenerationType;
    import jakarta.persistence.Id;
    import jakarta.persistence.Table;
    import lombok.AllArgsConstructor;
    import lombok.Builder;
    import lombok.Data;
    import lombok.NoArgsConstructor;
    
    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    @Entity
    @Table(name = "admin_account")
    @DynamicInsert //입력이 안된 null값은 default값을 입력
    @Builder //입력한 값만 입력. 객체 생성 시 없는 값은 제외하고 입력
    public class AdminAccountEntity {
         @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
         @Column(name="ai_seq")                            private Long aiSeq;
         @Column(name="ai_id")                             private String aiId;
         @Column(name="ai_pwd")                            private String aiPwd;
         @Column(name="ai_name")                           private String aiName;
         @Column(name="ai_grade")  @ColumnDefault("1")     private Integer aiGrade;
         @Column(name="ai_status") @ColumnDefault("0")     private Integer aiStatus;
    }
    ```
    
    ```java
    package com.greenart.book_info;
    
    import org.junit.jupiter.api.Test;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.boot.test.context.SpringBootTest;
    import org.springframework.transaction.annotation.Transactional;
    
    import com.greenart.book_info.entity.AdminAccountEntity;
    import com.greenart.book_info.repository.AdminAccountRepository;
    
    @SpringBootTest
    class BookInfoApplicationTests {
    
    	@Autowired AdminAccountRepository aRepo;
    
    	@Test
    	@Transactional
    	void addAdmin() {
    		AdminAccountEntity account = AdminAccountEntity.builder().aiId("admin").aiPwd("1234").aiName("관리자").build();
    		aRepo.save(account);
    		System.out.println(account);
    	}
    
    }
    ```
    
    모든 값을 입력하지 않고도 생성가능함.(생성자와 동일한 역할이나 입력하지 않을 멤버변수에 null을 사용하지않고 생성가능)
    
- 중복아이디시 입력값 살리는 법
    
    ```java
    package com.greenart.book_info.controller;
    
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.stereotype.Controller;
    import org.springframework.ui.Model;
    import org.springframework.web.bind.annotation.GetMapping;
    import org.springframework.web.bind.annotation.PostMapping;
    import org.springframework.web.bind.annotation.RequestMapping;
    
    import com.greenart.book_info.entity.AdminAccountEntity;
    import com.greenart.book_info.repository.AdminAccountRepository;
    
    @Controller
    @RequestMapping("/member")
    public class MemberController {
    
         @Autowired AdminAccountRepository aRepo;
    
         @GetMapping("/join") //requestMapping
         public String getMemberJoin(){
              return "/member/join"; //application.properties prefix, suffix기준
         }
         @PostMapping("/join")
         public String postMemberJoin(String id, String pwd, String name, Model model){
              if(aRepo.countByAiId(id)>0){
                   model.addAttribute("id", id);
                   model.addAttribute("name", name);
                   model.addAttribute("status", "duplicated");
                   return "/member/join"; 
              }else{
                   AdminAccountEntity data = AdminAccountEntity.builder().aiId(id).aiPwd(pwd).aiName(name).build();
                   aRepo.save(data);
              }
              return "/login"; //가입 성공하면 바로 로그인페이지로
         }
    }
    ```
    
    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
         <meta charset="UTF-8">
         <meta http-equiv="X-UA-Compatible" content="IE=edge">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Document</title>
    </head>
    <body>
         <h1>관리자 등록</h1> 
         <form action="/member/join" method="post">
              <!-- table>tbody>(tr>td*2)*3 입력하면 자동으로 틀 만들어줌-->
              <table>
                   <tbody>
                        <tr>
                             <td>아이디</td>
                             <td><input type="text" name="id" th:value="${id}"></td>
                             <td><span th:if="${status=='duplicated'}" style="color: red;">중복 아이디 입니다.</span></td>
                        </tr>
                        <tr>
                             <td>비밀번호</td>
                             <td><input type="password" name="pwd"></td>
                        </tr>
                        <tr>
                             <td>이름</td>
                             <td><input type="text" name="name" th:value="${name}"></td>
                        </tr>
                        <tr>
                             <td colspan="2">
                                  <input type="submit" value="관리자 등록">
                             </td>
                        </tr>
                   </tbody>
              </table>
         </form>
    </body>
    </html>
    ```
    
    중복아이디 입력으로 실패처리돼도 아이디와 이름의 값이 유지가 되고 메세지가 뜸
	![images](/assets/images/green/IMG-20240908160524-1.png)
    
- 공백검사
    
    ```java
    String replacedId = id.replaceAll(" ", ""); //문자열 공백 제거
              if(id.length()!=replacedId.length()){ //공백이 있었다면 문자열의 길이가 달라짐
                   model.addAttribute("status", "whitespaceId");
                   return "/member/join"; 
              }
              String replacedPwd = pwd.replaceAll(" ", ""); //문자열 공백 제거
              if(pwd.length()!=replacedPwd.length()){ //공백이 있었다면 문자열의 길이가 달라짐
                   model.addAttribute("status", "whitespacePwd");
                   return "/member/join"; 
              }
    ```
    
    메소드에 추가 후 html에 if문 추가
    
- 영문, 숫자만 가능하도록 추가 - 정규표현식 사용
    
    ```java
    String kor_pattern = "^[a-zA-Z0-9]*$"; //영어, 숫자만 가능
              Pattern p = Pattern.compile(kor_pattern);
              if(!p.matcher(id).matches()){
                   model.addAttribute("status", "invalidId");
                   return "/member/join"; 
              }
    ```
    
    메소드에 추가 후 html에 if문 추가
    
    이메일, 전화번호 형식 등 검색하면 정규표현식 뜸. 복붙해서 쓰면됨
    
    정규표현식으로 공백도 걸러지니 정규표현식을 사용한다면 위의 공백검사는 안해줘도됨
    
- 로그인
    
    ```java
    @GetMapping("/login")
    public String getLogin(HttpServletResponse response){
        response.setHeader("Cache-Control", "no-cache, no-store, must-revalidate");
        response.setHeader("Pragma", "no-cache");
        response.setHeader("Expires", "0"); //로그인 후 뒤로가기했을때 비밀번호가 뜨지않도록 캐시를 날림
        return "/login";
    }
    @PostMapping("/login")
    public String postLogin(String id, String pwd, Model model, HttpSession session){ 
        //session - 값들을 저장하는 저장소(전체서비스에서 한개 = 전역적임[전체영역에서 접근 가능])
        System.out.println(id);
        System.out.println(pwd);
        AdminAccountEntity loginUser = adminAccountRepository.findByAiIdAndAiPwd(id, pwd);
        //다른 URL로 들어가면 loginUser는 사용할 수 없음
        if(loginUser==null){
             model.addAttribute("loginStatus", "failed");
             model.addAttribute("message", "아이디 또는 비밀번호 오류입니다.");
             return "/login";
        }
        session.setAttribute("loginUser", new LoginUserVO(loginUser));
        //session은 다른 URL로 들어가도 사용가능
        return "redirect:/"; //로그인성공하면 메인화면으로(파일경로아니고 매핑경로 기준.)
    }
    ```
    
    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
         <meta charset="UTF-8">
         <meta http-equiv="X-UA-Compatible" content="IE=edge">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Document</title>
    </head>
    <body>
         <h1>login</h1>
         <form action="/login" method="post">
              <table>
                   <tr>
                        <td>아이디</td>
                        <td><input type="text" name="id"></td>
                   </tr>
                   <tr>
                        <td>비밀번호</td>
                        <td><input type="password" name="pwd"></td>
                   </tr>
                   <tr>
                        <td colspan="2">
                        <button>로그인</button>
                   </tr>
                   <tr>
                        <td colspan="2">
                             <a href="/member/join">관리자 등록</a>
                        </td>
                   </tr>
              </table>
         </form>
         <div th:if="${loginStatus == 'failed'}">
              <p th:text="${message}" style="color: red; font-weight: bold; font-size: 14px;"></p>
         </div>
    </body>
    </html>
    ```
    
- 계정 조회 후 상태값 변경, 계정 삭제
    
    영속성 조심(수정했다가 원본 테이블 수정될까봐)!! 새 객체 만들어줌
    
    ```java
    package com.greenart.book_info.VO;
    
    import com.greenart.book_info.entity.AdminAccountEntity;
    
    import lombok.Data;
    @Data
    public class AdminAccountVo {
         private Long seq;
         private String id;
         private String name;
         private Integer grade;
         private Integer status;
    
         public AdminAccountVo(AdminAccountEntity account){
              this.seq = account.getAiSeq();
              this.id = account.getAiId();
              this.name = account.getAiName();
              this.grade = account.getAiGrade();
              this.status = account.getAiStatus();
         }
    }
    ```
    
    ```java
    @GetMapping("/list")
    public String getMemberList(Model model, Pageable pageable
    ){
        Page<AdminAccountEntity> page = aRepo.findAll(pageable);
        List<AdminAccountVo> result = new ArrayList<>();
        for(AdminAccountEntity a : page.getContent()){
             result.add(new AdminAccountVo(a));
        }
        model.addAttribute("accountList", result);
        model.addAttribute("totalPage", page.getTotalPages());
        model.addAttribute("totalCount", page.getTotalElements());
        model.addAttribute("getMemberJoin()", page.getNumber());
        return "member/list";
    }
    @GetMapping("/status")
    public String getMemberStatusUpdate(@RequestParam Long seq, @RequestParam Integer status){
        AdminAccountEntity entity = aRepo.findByAiSeq(seq); //select문
        entity.setAiStatus(status); //값 변경
        aRepo.save(entity); //ctrl + s
        // -> update
        return "redirect:/member/list";
    }
    @GetMapping("/delete")
    public String getMemberDelete(@RequestParam Long seq){
        AdminAccountEntity entity = aRepo.findByAiSeq(seq);
        aRepo.delete(entity); //삭제
        return "redirect:/member/list";
    }
    ```
    
    result에 new를 써서 새로운 객체를 만들어준것이 영속성 제거를 위해 사용한 것임
    
    @{URL}(param=${value}) 형식으로
    
    @{/member/status(seq=${admin.seq})} 이런식.
    
    admin.seq에 해당 멤버의 seq값이 자동으로 들어감 최종적으로
    
    /member/status?seq=7 이런식으로 주소가 생성됨
    
    — 파라미터 추가 @{/member/status(seq=${admin.seq}, status=1)} 이런식
    
    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
         <meta charset="UTF-8">
         <meta http-equiv="X-UA-Compatible" content="IE=edge">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Document</title>
    </head>
    <body>
         <h1>Admin Account List</h1>
         <!-- <p th:text="${accountList}"></p> -->
         <table>
              <thead>
    
                   <tr>
                        <th>번호</th>
                        <th>아이디</th>
                        <th>이름</th>
                        <th>등급</th>
                        <th>상태</th>
                   </tr>
              </thead>
              <tbody>
                   <tr th:each="admin, i : ${accountList}"> <!-- 반복문 -->
                        <td th:text="${admin.seq}"></td>
                        <td th:text="${admin.id}"></td>
                        <td th:text="${admin.name}"></td>
                        <td>
                             <th:block th:switch="${admin.grade}">
                                  <span th:case="1">일반</span>
                                  <span th:case="99">슈퍼유저</span>
                             </th>
                        </td>
                        <td>
                             <th:block th:switch="${admin.status}">
                                  <span th:case="0">등록대기</span>
                                  <span th:case="1">사용가능</span>
                                  <span th:case="2">사용정지</span>
                             </th>
                        </td>
                        <td>
                             <th:block th:if="${admin.status==0}">
                                  <a th:href="@{/member/status(seq=${admin.seq}, status=1)}">사용 승인</a>
                             </th:block>
                             <th:block th:if="${admin.status==1}">
                                  <a th:href="@{/member/status(seq=${admin.seq}, status=2)}">사용 정지</a>
                             </th:block>
                             <th:block th:if="${admin.status==2}">
                                  <a th:href="@{/member/status(seq=${admin.seq}, status=1)}">사용 승인</a>
                             </th:block>
                        </td>
                        <td>
                             <th:block>
                                  <a th:href="@{/member/delete(seq=${admin.seq})}">삭제</a>
                             </th:block>
                        </td>
                   </tr>
              </tbody>
         </table>
         <div>
              <span th:each="num : ${\#numbers.sequence(1, totalPage)}">
                   <a th:href="@{/member/list(page=${num-1},size=10,sort=aiSeq,desc)}" th:text=" ${num}"></a>
              </span>
         </div>
    </body>
    </html>
    ```

    ![](/assets/images/green/IMG-20240908160524.mp4)
    <video controls width="640" height="360"> <source src="/assets/images/green/IMG-20240908160524.mp4" type="video/mp4"></video>
    
    ![](/assets/images/green/IMG-20240908160524-1.mp4)
    <video controls width="640" height="360"> <source src="/assets/images/green/IMG-20240908160524-1.mp4" type="video/mp4"></video>
	![images](/assets/images/green/IMG-20240908160524-2.png)
    
    페이지 기능 추가. 페이지 누르면 이동됨
    
- 슈퍼유저만 관리자리스트페이지 접근가능
    
    ```java
    @GetMapping("/list")
    public String getMemberList(
        Model model, 
        @PageableDefault(size=10, sort="aiSeq", direction =Sort.Direction.DESC) Pageable pageable,
        HttpSession session
    ){
        LoginUserVO login = (LoginUserVO)session.getAttribute("loginUser");
        if(login == null){
             return "redirect:/login";
        }
        Page<AdminAccountEntity> page = aRepo.findAll(pageable);
        List<AdminAccountVo> result = new ArrayList<>();
        for(AdminAccountEntity a : page.getContent()){
             result.add(new AdminAccountVo(a));
        }
        model.addAttribute("accountList", result);
        model.addAttribute("totalPage", page.getTotalPages());
        model.addAttribute("totalCount", page.getTotalElements());
        model.addAttribute("getMemberJoin()", page.getNumber());
        return "member/list";
    }
      
    ```
    
    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
         <meta charset="UTF-8">
         <meta http-equiv="X-UA-Compatible" content="IE=edge">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Document</title>
              <script th:inline="javascript">
              /* <![CDATA[ */
                   const grade = /*[[${session.loginUser.grade}]]*/;
                   if(grade==1){
                        alert("마스터 관리자만 접근 가능한 메뉴입니다.");
                        location.href="/";
                   }
              /* ]] */
         </script>
    </head>
    <body>
         <h1>Admin Account List</h1>
         <!-- <p th:text="${accountList}"></p> -->
         <table>
              <thead>
    
                   <tr>
                        <th>번호</th>
                        <th>아이디</th>
                        <th>이름</th>
                        <th>등급</th>
                        <th>상태</th>
                   </tr>
              </thead>
              <tbody>
                   <tr th:each="admin, i : ${accountList}"> <!-- 반복문 -->
                        <td th:text="${admin.seq}"></td>
                        <td th:text="${admin.id}"></td>
                        <td th:text="${admin.name}"></td>
                        <td>
                             <th:block th:switch="${admin.grade}">
                                  <span th:case="1">일반</span>
                                  <span th:case="99">슈퍼유저</span>
                             </th>
                        </td>
                        <td>
                             <th:block th:switch="${admin.status}">
                                  <span th:case="0">등록대기</span>
                                  <span th:case="1">사용가능</span>
                                  <span th:case="2">사용정지</span>
                             </th>
                        </td>
                        <td>
                             <th:block th:if="${admin.status==0}">
                                  <a th:href="@{/member/status(seq=${admin.seq}, status=1)}">사용 승인</a>
                             </th:block>
                             <th:block th:if="${admin.status==1}">
                                  <a th:href="@{/member/status(seq=${admin.seq}, status=2)}">사용 정지</a>
                             </th:block>
                             <th:block th:if="${admin.status==2}">
                                  <a th:href="@{/member/status(seq=${admin.seq}, status=1)}">사용 승인</a>
                             </th:block>
                        </td>
                        <td>
                             <th:block>
                                  <a th:href="@{/member/delete(seq=${admin.seq})}">삭제</a>
                             </th:block>
                        </td>
                   </tr>
              </tbody>
         </table>
         <div>
              <span th:each="num : ${\#numbers.sequence(1, totalPage)}">
                   <a th:href="@{/member/list(page=${num-1})}" th:text=" ${num}"></a>
              </span>
         </div>
    </body>
    </html>
    ```
	![images](/assets/images/green/IMG-20240908160525.png)
    
- 로그아웃
    
    ```java
    @GetMapping("/logout")
         public String getLogout(HttpSession session){
              // session.invalidate(); //세션 정보 모두 삭제
              session.setAttribute("loginUser", null); //session에 다른정보가 있다면
              return "redirect:/";  
         }
    ```
    
- 책 DB 생성
    
    ```sql
    create table writer_info(
    	wi_seq int not null auto_increment primary key,
    	wi_name varchar(100) not null,
    	wi_introduce text null,
    	wi_img varchar(255) default 'writer_default.jpg'
    );
    create table translator_info(
    	ti_seq int not null auto_increment primary key,
    	ti_name varchar(100) not null,
    	ti_introduce text null,
    	ti_img varchar(255) default 'translator_default.jpg'
    );
    create table publish_company(
    	pc_seq int not null auto_increment primary key,
    	pc_name varchar(255) not null
    );
    
    create table book_info(
    	bi_seq int not null auto_increment primary key,
    	bi_title varchar(255) not null,
    	bi_sub_title varchar(255) null,
    	bi_price int not null default 0,
    	bi_discount double not null default 0.1,
    	bi_point double not null default 0.05,
    	bi_pub_dt datetime not null,
    	bi_wi_seq int null,
    	bi_ti_seq int null,
    	bi_pub_seq int null,
    	foreign key (bi_wi_seq) references writer_info(wi_seq) on delete set null on update cascade, -- 작가 삭제시 책정보 null, 작가변경시 책도 변경
    	foreign key (bi_ti_seq) references translator_info(ti_seq) on delete set null on update cascade, -- 번역가 삭제시 책정보 null, 번역가 변경시 책도 변경
    	foreign key (bi_pub_seq) references publish_company(pc_seq) on delete set null on update cascade -- 출판사 삭제시 책정보 null, 출판사 변경시 책도 변경
    );
    ```
    
    foreign key 설정함.
    
    ```java
    package com.greenart.book_info.entity;
    
    import java.time.LocalDate;
    
    import org.hibernate.annotations.ColumnDefault;
    import org.hibernate.annotations.DynamicInsert;
    
    import jakarta.persistence.Column;
    import jakarta.persistence.Entity;
    import jakarta.persistence.GeneratedValue;
    import jakarta.persistence.GenerationType;
    import jakarta.persistence.Id;
    import jakarta.persistence.Table;
    import lombok.AllArgsConstructor;
    import lombok.Data;
    import lombok.NoArgsConstructor;
    
    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    @Entity
    @Table(name = "book_info")
    @DynamicInsert
    public class BookInfoEntity {
         @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
         @Column(name="bi_seq")         private Long biSeq;
         @Column(name="bi_title")       private String biTitle;
         @Column(name="bi_sub_title")   private String biSubTitle;     
         @Column(name="bi_price")       private Integer biPrice;     
         @Column(name="bi_discount") @ColumnDefault("0.1")   private Double biDiscount;     
         @Column(name="bi_point")    @ColumnDefault("0.05")   private Integer biPoint;     
         @Column(name="bi_pub_dt")      private LocalDate biPubDt;     
         @Column(name="bi_wi_seq")      private Long biWiSeq;     
         @Column(name="bi_ti_seq")      private Long biTiSeq;     
         @Column(name="bi_pub_seq")     private Long biPubSeq;     
    
    }
    ```
    
    ```java
    package com.greenart.book_info.entity;
    
    import org.hibernate.annotations.ColumnDefault;
    import org.hibernate.annotations.DynamicInsert;
    
    import jakarta.persistence.Column;
    import jakarta.persistence.Entity;
    import jakarta.persistence.GeneratedValue;
    import jakarta.persistence.GenerationType;
    import jakarta.persistence.Id;
    import jakarta.persistence.Table;
    import lombok.AllArgsConstructor;
    import lombok.Data;
    import lombok.NoArgsConstructor;
    
    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    @Entity
    @Table(name = "publish_company")
    public class PublishCompanyEntity {
         @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
         @Column(name="pc_seq")        private Long pcSeq;
         @Column(name="pc_name")       private String pcName;  
    }
    ```
    
    ```java
    package com.greenart.book_info.entity;
    
    import org.hibernate.annotations.ColumnDefault;
    import org.hibernate.annotations.DynamicInsert;
    
    import jakarta.persistence.Column;
    import jakarta.persistence.Entity;
    import jakarta.persistence.GeneratedValue;
    import jakarta.persistence.GenerationType;
    import jakarta.persistence.Id;
    import jakarta.persistence.Table;
    import lombok.AllArgsConstructor;
    import lombok.Data;
    import lombok.NoArgsConstructor;
    
    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    @Entity
    @Table(name = "translator_info")
    @DynamicInsert
    public class TranslatorInfoEntity {
         @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
         @Column(name="ti_seq")        private Long tiSeq;
         @Column(name="ti_name")       private String tiName;
         @Column(name="ti_introduce")  private String tiIntroduce;     
         @Column(name="ti_img") @ColumnDefault("translator_default.jpg") private String tiImg;
    }
    ```
    
    ```java
    package com.greenart.book_info.entity;
    
    import org.hibernate.annotations.ColumnDefault;
    import org.hibernate.annotations.DynamicInsert;
    
    import jakarta.persistence.Column;
    import jakarta.persistence.Entity;
    import jakarta.persistence.GeneratedValue;
    import jakarta.persistence.GenerationType;
    import jakarta.persistence.Id;
    import jakarta.persistence.Table;
    import lombok.AllArgsConstructor;
    import lombok.Data;
    import lombok.NoArgsConstructor;
    
    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    @Entity
    @Table(name = "writer_info")
    @DynamicInsert
    public class WriterInfoEntity {
         @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
         @Column(name = "wi_seq")           private Long wiSeq;
         @Column(name = "wi_name")          private String wiName;
         @Column(name = "wi_introduce")     private String wiIntroduce;     
         @Column(name = "wi_img") @ColumnDefault("writer_default.jpg") private String wiImg;
    }
    ```
    
- 책 추가(연관관계매핑)
    
    ```java
    package com.greenart.book_info.entity;
    
    import java.time.LocalDate;
    
    import org.hibernate.annotations.ColumnDefault;
    import org.hibernate.annotations.DynamicInsert;
    import org.springframework.beans.factory.annotation.Autowired;
    
    import com.greenart.book_info.VO.BookAddVO;
    import com.greenart.book_info.repository.PublishCompanyRepository;
    import com.greenart.book_info.repository.TranslatorInfoRepository;
    import com.greenart.book_info.repository.WriterInfoRepository;
    
    import jakarta.persistence.Column;
    import jakarta.persistence.Entity;
    import jakarta.persistence.GeneratedValue;
    import jakarta.persistence.GenerationType;
    import jakarta.persistence.Id;
    import jakarta.persistence.JoinColumn;
    import jakarta.persistence.ManyToOne;
    import jakarta.persistence.Table;
    import lombok.AllArgsConstructor;
    import lombok.Builder;
    import lombok.Data;
    import lombok.NoArgsConstructor;
    
    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    @Entity
    @Table(name = "book_info")
    @DynamicInsert
    @Builder
    public class BookInfoEntity {
         @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
         @Column(name="bi_seq")         private Long biSeq;
         @Column(name="bi_title")       private String biTitle;
         @Column(name="bi_sub_title")   private String biSubTitle;     
         @Column(name="bi_price")       private Integer biPrice;     
         @Column(name="bi_discount") @ColumnDefault("0.1")   private Double biDiscount;     
         @Column(name="bi_point")    @ColumnDefault("0.05")   private Double biPoint;     
         @Column(name="bi_pub_dt")      private LocalDate biPubDt; 
         @ManyToOne @JoinColumn(name="bi_wi_seq") WriterInfoEntity writer;
         @ManyToOne @JoinColumn(name = "bi_ti_seq") TranslatorInfoEntity translator;
         @ManyToOne @JoinColumn(name = "bi_pub_seq") PublishCompanyEntity publisher;
    
         public BookInfoEntity(BookAddVO data){
              this.biTitle = data.getTitle();
              this.biSubTitle   = data.getSub_title();
              this.biPrice  = data.getPrice();
              this.biDiscount   = data.getDiscount()/100.0;
              this.biPoint  = data.getPoint()/100.0;
              this.biPubDt  = data.getPub_dt();
         }
    }
    ```
    
    ```java
    package com.greenart.book_info.controller;
    
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.stereotype.Controller;
    import org.springframework.ui.Model;
    import org.springframework.web.bind.annotation.GetMapping;
    import org.springframework.web.bind.annotation.PostMapping;
    import org.springframework.web.bind.annotation.RequestMapping;
    
    import com.greenart.book_info.VO.BookAddVO;
    import com.greenart.book_info.entity.BookInfoEntity;
    import com.greenart.book_info.repository.BookInfoRepository;
    import com.greenart.book_info.repository.PublishCompanyRepository;
    import com.greenart.book_info.repository.TranslatorInfoRepository;
    import com.greenart.book_info.repository.WriterInfoRepository;
    
    @Controller
    @RequestMapping("/book")
    public class BookInfoController {
    
         @Autowired TranslatorInfoRepository tRepo;
         @Autowired WriterInfoRepository wRepo;
         @Autowired BookInfoRepository bRepo;
         @Autowired PublishCompanyRepository pRepo;
    
         @GetMapping("/add")
         public String getBookAdd(Model model){
              model.addAttribute("writerList", wRepo.findAll());
              model.addAttribute("translatorList", tRepo.findAll());
              model.addAttribute("publisherList", pRepo.findAll());
              return "/book/add";
         }
         @PostMapping("/add")
         public String postBookAdd(BookAddVO data){
              BookInfoEntity entity = BookInfoEntity.builder()
                   .biTitle(data.getTitle())
                   .biSubTitle(data.getSub_title())
                   .biPrice(data.getPrice())
                   .biDiscount(data.getDiscount()/100.0)
                   .biPoint(data.getPoint()/100.0)
                   .biPubDt(data.getPub_dt())
                   .writer(wRepo.findByWiSeq(data.getWriter()))
                   .translator(tRepo.findByTiSeq(data.getTranslator()))
                   .publisher(pRepo.findByPcSeq(data.getPublisher()))
                   .build();
              bRepo.save(entity);
              return "redirect:/";
         }
    
         
    }
    ```
    
    ```html
    <!DOCTYPE html>
    <html>
    <head>
         <meta charset="UTF-8">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Document</title>
         <style>
              body {text-align: center;}
              \#input_form_table {margin: 0 auto; border-collapse: collapse;} 
              \#input_form_table input {width: 70%;}
              \#input_form_table td {padding: 10px;}
         </style> <!-- css -->
    </head>
    <body>
         <h1>책 정보 추가</h1>
         <form action="/book/add" method="post">
              <table border="1" id="input_form_table">
                   <tbody>
                        <tr>
                             <td>책 제목</td>
                             <td colspan="2"><input type="text" name="title"></td>
                             <td>출간일</td>
                             <td colspan="2"><input type="text" name="pub_dt"></td>
                        </tr>
                        <tr>
                             <td>부제목</td>
                             <td colspan="5"><input type="text" name="sub_title"></td>
                        </tr>
                        <tr>
                             <td>작가</td>
                             <td>
                                  <select name="writer">
                                       <option value="0">선택안함</option>
                                       <option th:each="writer, i : ${writerList}" th:text="${writer.wiName}" th:value="${writer.wiSeq}"></option>
                                  </select>
                             </td>
                             <td>번역가</td>
                             <td>
                                  <select name="translator">
                                       <option value="0">선택안함</option>
                                       <option th:each="translator, i : ${translatorList}" th:text="${translator.tiName}" th:value="${translator.tiSeq}"></option>
                                  </select>
                             </td>
                             <td>출판사</td>
                             <td>
                                  <select name="publisher">
                                       <option value="0">선택안함</option>
                                       <option th:each="publisher, i : ${publisherList}" th:text="${publisher.pcName}" th:value="${publisher.pcSeq}"></option>
                                  </select>
                             </td>
                             <td></td>
                        </tr>
                        <tr>
                             <td>가격</td>
                             <td><input type="number" name="price" min="0">원</td>
                             <td>할인률</td>
                             <td><input type="number" name="discount" min="0" max="100">%</td>
                             <td>적립율</td>
                             <td><input type="number" name="point" min="0" max="100">%</td>
                        </tr>
                        <tr>
                             <td colspan="6">
                                  <button>저장</button>
                                  <a href="/">돌아가기</a>
                             </td>
                        </tr>
                   </tbody>
              </table>
         </form>
    </body>
    </html>
    ```
    
      
    

---

```java
package com.greenart.book_info.entity;

import jakarta.persistence.CascadeType;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@AllArgsConstructor
@NoArgsConstructor
@Entity
@Table(name="student_info")
public class StudentInfoEntity {
     @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
     @Column(name="stu_seq") private Long stuSeq;
     @Column(name="stu_name") private String stuName;
     // @Column(name="stu_major_seq") private Long stuMajorSeq;
     @ManyToOne(cascade = CascadeType.PERSIST) @JoinColumn(name="stu_major_seq") private StudentMajorEntity major;
}
```

```java
@Test
	void addStudent(){
		StudentInfoEntity stu = new StudentInfoEntity();
		stu.setStuName("박학생");
		stu.setMajor(new StudentMajorEntity(null, "컴퓨터 공학과")); //Major도 함께 insert됨
		stuRepo.save(stu);
	}
```

cascade = CascadeType.PERSIST때문에 가능함. 학과테이블에 중복을 허용하지않아서 이미 있는 값으로 테스트하면 에러남.

연계되는 정보를 같이 지정하겠다는 의미

setMajor를 할때 student_major테이블에도 자동으로 insert됨

cascade = CascadeType.PERSIST를 붙이지 않고도 하려면 테스트코드를 이런식으로짜야함

```java
@Test
	void addStudent2(){
		StudentInfoEntity stu = new StudentInfoEntity();
		stu.setStuName("최학생");
		stu.setMajor(majorRepo.findById(3L).get()); //Major도 함께 insert됨
		stuRepo.save(stu);
	}
```

직접 찾아서 넣겠다는 의미라 cascade가 붙으면 에러남

---

사용자 →(요청)→ 컨트롤러 →(데이터)→ 모델+뷰 → HTML ⇒(응답)⇒ 사용자

- session, Model 설명
    
    endpoint
    
	![images](/assets/images/green/IMG-20240908160525-1.png)
    
    이거말하는거임
    
      
    
    영문이아니면 한글자에 길이가 2로 계산하는 시스템도있으니 주의할것
    
    - 세션초기화
        
        session.invalidate(); 사용
        
    
    ```java
    package com.greenart.testproject.main.controller;
    
    import org.springframework.stereotype.Controller;
    import org.springframework.ui.Model;
    import org.springframework.web.bind.annotation.GetMapping;
    
    import jakarta.servlet.http.HttpSession;
    
    @Controller
    public class MainController {
         @GetMapping("/")
         public String getMain(Model model, HttpSession session){
              //Model - 데이터를 실어나르는 박스(데이터 컨텍스트)
              model.addAttribute("hello", "Hello World!!");
              //웹페이지 파일이 로드되기전에 생성됨
              session.setAttribute("sessionValue", "세션에 추가된 값");
              //백엔드 시스템에서, 세션무효화를 실행했을때 세션을 다시만든다.
    
              return "/index";
         }
    
         @GetMapping("/index")
         public String getIndex(Model model){
              model.addAttribute("hello", "@GetMapping(\"index\")를 통한 응답");
              return "/index";
         }
         @GetMapping("/invalidate")
         public String getInvalidate(HttpSession session){
              session.invalidate(); //세션 초기화
              return "redirect:/index";
              //index는 endpoint에서 찾음
         }
    }
    ```
    
    엔티티에 기본키값이 설정되어있다면 save를 했을때 업데이트로 적용됨
    
    - 회원탈퇴
    
    ```java
    <!DOCTYPE html>
    <html lang="en">
    <head>
         <meta charset="UTF-8">
         <meta http-equiv="X-UA-Compatible" content="IE=edge">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Document</title>
    </head>
    <body>
         <h1>회원탈퇴</h1>
         <h2 style="color: red;">정말 탈퇴하시겠습니까?</h2>
         <form action="member/leave" method="post" id="leave_form">
              <input type="checkbox" id="agree">
              <label for="agree">회원탈퇴시 발생하는 손해에대해서 책임지겠습니다.</label>
              <button id="leave">회원탈퇴</button>
              <a href="/">메인으로</a>
         </form>
         <script>
              document.getElementById("leave").addEventListener("click", function(e){
                   e.preventDefault();
                   if(!document.getElementById("agree").checked){
                        alert("체크박스에 체크를 해주셔야 탈퇴 진행이 가능합니다.")
                        return;
                   }
                   if(confirm("진짜 탈퇴하시겠습니까?")){
                        alert("탈퇴");
                        document.getElementById("leave_Form").submit();
                   }
              })
         </script>
    </body>
    </html>
    ```
    
    스크립트를 써야 탈퇴 메세지창이 뜸
    
    ```java
    package com.greenart.testproject.main.repository;
    
    import org.springframework.data.jpa.repository.JpaRepository;
    import org.springframework.stereotype.Repository;
    
    import com.greenart.testproject.main.entity.User;
    
    @Repository
    public interface UserRepository extends JpaRepository<User, Long> {
         Integer countByUserId(String userId);
         public User findByUserIdAndUserPwd(String userId, String userPwd);
         //delete from user_info where user_id = 'user_id'
         public void deleteByUserId(String UserId);
    }
    ```
    
      
    
      
    
    - 서버 여는 코드(SQL)
        
        use mysql;
        
        create user 'root'@'%' identified by '1234';
        
        grant all privileges on *.* to 'root'@'%';
        
        flush privileges;
        
          
        
    
      
    
    히스토리 테이블은 서비스가 정상 작동하는것을 확인한 후에 독립적인 테이블을 만들어주면됨
    
    (FK없이 순수데이터로만 들어가야함)