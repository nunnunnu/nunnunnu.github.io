---
ìƒì„±ì¼: 2024ë…„ 2ì›” 26ì¼ ì˜¤í›„ 9:13
í•˜ìœ„íƒœê·¸:
  - ìŠ¤í”„ë§ í•µì‹¬ì›ë¦¬ - ê³ ê¸‰
last_modified_at: 2024-03-02
title: "[ê¹€ì˜í•œ ìŠ¤í”„ë§ í•µì‹¬ì›ë¦¬ - ê³ ê¸‰] í”„ë¡ì‹œ ë‚´ë¶€ í˜¸ì¶œ"
category: Spring
tags:
  - spring
  - ê¹€ì˜í•œìŠ¤í”„ë§í•µì‹¬ì›ë¦¬-ê³ ê¸‰
  - í”„ë¡ì‹œ
---
## ë¬¸ì œ

```java
package hello.aop.internalcall;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
 
@Slf4j
@Component
public class CallServiceV0 {
    public void external() {
        log.info("call external");

        internal(); //ë‚´ë¶€ ë©”ì†Œë“œ í˜¸ì¶œ(this.internal())
    }

    public void internal() {
        log.info("call internal");
    }
}

```

```java
package hello.aop.internalcall.aop;

import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;

@Slf4j
@Aspect
public class CallLogAspect {
    @Before("execution(* hello.aop.internalcall..*.*(..))")
    public void doLog(JoinPoint joinPoint) {
        log.info("aop={}", joinPoint.getSignature());
    }
}

```

```java
package hello.aop.internalcall.aop;

import hello.aop.internalcall.CallServiceV0;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.annotation.Import;

import static org.junit.jupiter.api.Assertions.*;
@Slf4j
@SpringBootTest
@Import({CallLogAspect.class})
class CallLogAspectTest {

    @Autowired
    CallServiceV0 callServiceV0;

    @Test
    void external() {
        log.info("target={}", callServiceV0.getClass());
        callServiceV0.external();
    }

    @Test
    void internal() {
        callServiceV0.internal();
    }
}
```

ë¬¸ì œë¥¼ íŒŒì•…í•˜ê¸°ìœ„í•œ ê¸°ë³¸ êµ¬ì¡°

externalì„ ì‹¤í–‰í•˜ë©´ internalì„ í˜¸ì¶œí•œë‹¤

ê·¸ë ‡ë‹¤ë©´ ì—¬ê¸°ì„œ externalê³¼ internal ë‘˜ë‹¤ ì–´ë“œë°”ì´ìŠ¤ì— ì ìš©ì‹œí‚¨ë‹¤ë©´ external ì‹¤í–‰í• ë•Œ AOPí•œë²ˆ internalì‹¤í–‰í• ë•Œ AOPí•œë²ˆ ë™ì‘í• ê¹Œ?

ì•„ë‹˜

external ì‹¤í–‰í•œ í›„ ë¡œê·¸

2024-02-26T21:34:32.618+09:00  INFO 14464 --- [    Test worker] h.aop.internalcall.aop.CallLogAspect     : aop=void hello.aop.internalcall.CallServiceV0.external()
2024-02-26T21:34:32.618+09:00  INFO 14464 --- [    Test worker] hello.aop.internalcall.CallServiceV0     : call external
2024-02-26T21:34:32.618+09:00  INFO 14464 --- [    Test worker] hello.aop.internalcall.CallServiceV0     : call internal

ì²˜ìŒ external ì‹¤í–‰ ì‹œ aopê°€ ì ìš©ë˜ì–´ ë¡œê·¸ê°€ ì°íˆë‚˜ internalì„ í˜¸ì¶œí–ˆì„ë•ŒëŠ” ë¡œê·¸ê°€ ì°íˆì§€ì•ŠìŒ

![images](/assets/images/high/IMG-20240909161736.png)
ì´ìœ ëŠ” í”„ë¡ì‹œë¥¼ í˜¸ì¶œ í•œ í›„ ì–´ë“œë°”ì´ìŠ¤ê°€ í˜¸ì¶œë˜ëŠ”ë° ì´ ì–´ë“œë°”ì´ìŠ¤ì—ì„œ externalë¥¼ í˜¸ì¶œí•´ì„œ ê·¸ëŸ¼

ì¦‰ externalë©”ì†Œë“œ ë‚´ì—ì„œ í˜¸ì¶œí•œ internalì€ ì–´ë“œë°”ì´ìŠ¤ë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ì–´ë“œë°”ì´ìŠ¤ë¥¼ í†µí•´ í˜¸ì¶œí•œ externalë¥¼ í†µí•´ í˜¸ì¶œí•œë‹¤ëŠ”ê²ƒ

ê·¸ë ‡ë‹¤ë©´ ë‹¤ë¥¸ í´ë˜ìŠ¤ì˜ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•œë‹¤ë©´ í•´ë‹¹ í´ë˜ìŠ¤ì˜ ì–´ë“œë°”ì´ìŠ¤ ì ìš©ì—¬ë¶€ë¥¼ ì²´í¬í•´ì•¼í•˜ê¸°ë•Œë¬¸ì— ì–´ë“œë°”ì´ìŠ¤ê°€ í˜¸ì¶œë ê²ƒìœ¼ë¡œ ì˜ˆìƒë¨

```java
package hello.aop.internalcall;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

@Slf4j
@Component
@RequiredArgsConstructor
public class CallServiceTest {
    private final CallServiceV0 callServiceV0;
    public void external() {
        log.info("call external");

        callServiceV0.internal(); //ì™¸ë¶€ ë©”ì†Œë“œ í˜¸ì¶œ
    }

    public void internal() {
        log.info("call internal");
    }
}

```

ì‹¤í—˜ì„ ìœ„í•´ ê°™ì€ êµ¬ì¡°ì˜ ì™¸ë¶€ ë©”ì„œë“œ í˜¸ì¶œ í´ë˜ìŠ¤ë¥¼ ìƒì„±í•¨

```java
package hello.aop.internalcall.aop;

import hello.aop.internalcall.CallServiceTest;
import hello.aop.internalcall.CallServiceV0;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.annotation.Import;

import static org.junit.jupiter.api.Assertions.*;
@Slf4j
@SpringBootTest
@Import({CallLogAspect.class})
class CallLogAspectTest {

    @Autowired
    CallServiceV0 callServiceV0;

    @Autowired
    CallServiceTest callServiceTest;
    @Test
    void external() {
        log.info("target={}", callServiceV0.getClass());
        callServiceV0.external();
    }

    @Test
    void external2() {
        log.info("target={}", callServiceTest.getClass());
        callServiceTest.external();
    }

    @Test
    void internal() {
        callServiceV0.internal();
    }
}
```

external2ë¥¼ ì‹¤í–‰í•œ ê²°ê³¼

2024-02-26T21:44:12.988+09:00  INFO 19592 --- [    Test worker] h.a.internalcall.aop.CallLogAspectTest   : target=class hello.aop.internalcall.CallServiceTest$ $SpringCGLIB$ $0
2024-02-26T21:44:12.993+09:00  INFO 19592 --- [    Test worker] h.aop.internalcall.aop.CallLogAspect     : aop=void hello.aop.internalcall.CallServiceTest.external()
2024-02-26T21:44:12.994+09:00  INFO 19592 --- [    Test worker] hello.aop.internalcall.CallServiceTest   : call external
2024-02-26T21:44:12.994+09:00  INFO 19592 --- [    Test worker] h.aop.internalcall.aop.CallLogAspect     : aop=void hello.aop.internalcall.CallServiceV0.internal()
2024-02-26T21:44:12.994+09:00  INFO 19592 --- [    Test worker] hello.aop.internalcall.CallServiceV0     : call internal

ì˜ ì°íˆëŠ”ê²ƒì„ í™•ì¸í•¨

> [!NOTE]
> ğŸ’¡ ì‹¤ì œ ì½”ë“œì— AOPë¥¼ ì§ì ‘ ì ìš©í•˜ëŠ” AspectJë¥¼ ì‚¬ìš©í•˜ë©´ ì´ëŸ° ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ
í”„ë¡ì‹œë¥¼ í†µí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ í•´ë‹¹ì½”ë“œì— AOPì½”ë“œë¥¼ ë¶™ì—¬ë„£ê¸°ë•Œë¬¸ì— ë‚´ë¶€í˜¸ì¶œê³¼ ë¬´ê´€í•˜ê²Œ AOPë¥¼ ì‚¬ìš©ê°€ëŠ¥í•¨
í•˜ì§€ë§Œ ì‚¬ìš©í•˜ê¸° ê¹Œë‹¤ë¡œì›Œì„œ ì‹¤ë¬´ì—ì„œëŠ” ê±°ì˜ ì‚¬ìš©í•˜ì§€ì•ŠëŠ”ë‹¤

## í•´ê²°ë²•

### ìê¸° ìì‹  ì£¼ì…

```java
package hello.aop.internalcall;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class CallServiceV1 {

    private CallServiceV1 callServiceV1; //ìˆœí™˜ì°¸ì¡°?

    @Autowired //ìˆœí™˜ì°¸ì¡° í•´ê²°ì„ ìœ„í•œ setterì£¼ì…
    public void setCallServiceV1(CallServiceV1 callServiceV1) {
        log.info("target={}", callServiceV1.getClass());
        this.callServiceV1 = callServiceV1;
    }

    public void external() {
        log.info("call external");

        callServiceV1.internal();
    }

    public void internal() {
        log.info("call internal");
    }
}
```

ê¸°ì¡´ì²˜ëŸ¼ ìƒì„±ì ì£¼ì… ë°©ë²•ì„ ì‚¬ìš©í•˜ê²Œ ëœë‹¤ë©´ ìˆœí™˜ì°¸ì¡° ë¬¸ì œê°€ ë°œìƒí•˜ê¸°ë•Œë¬¸ì— setterì£¼ì…ìœ¼ë¡œ ë³€ê²½í•˜ì˜€ë‹¤

ê·¸ëŸ¬ë‚˜ í˜„ ì‹œì ìœ¼ë¡œ setterì£¼ì…ì— @autowired ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ë„ ìˆœí™˜ì°¸ì¡°ê°€ ë°œìƒí•˜ì—¬ í™•ì¸í•´ë³´ë‹ˆ

ìŠ¤í”„ë§ 2.6 ë¶€í„° ìˆœí™˜ì°¸ì¡°ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ê¸ˆì§€í•˜ë„ë¡ ë³€ê²½ë˜ì–´ `spring.main.allow-circular-references=true` ë¥¼ ì¶”ê°€í•´ì£¼ì—ˆìŒ

```java
package hello.aop.internalcall;

import static org.junit.jupiter.api.Assertions.*;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.annotation.Import;

import hello.aop.internalcall.aop.CallLogAspect;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Import(CallLogAspect.class)
@SpringBootTest
class CallServiceV1Test {
	@Autowired
	CallServiceV1 callServiceV1;

	@Test
	void external() {
		callServiceV1.external();
	}

}
```

![images](/assets/images/high/IMG-20240909161736-1.png)

ê¸°ì¡´ì²˜ëŸ¼ ì–´ë“œë°”ì´ìŠ¤ë¡œ ì¸í•´ í˜¸ì¶œëœ ë¹ˆì˜ ë‚´ë¶€ë©”ì†Œë“œì—ì„œ ë°”ë¡œ ë‹¤ë¥¸ ë©”ì†Œë“œë¥¼ ì°¸ì¡°í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼

external()ì„ í˜¸ì¶œ í•œ í›„ ë‹¤ì‹œ ì–´ë“œë°”ì´ìŠ¤ë¥¼ í˜¸ì¶œí•˜ì—¬ internalì„ í˜¸ì¶œí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ

= internalì„ í˜¸ì¶œí• ë•Œ ìê¸°ìì‹ ì˜ ì¸ìŠ¤í„´ìŠ¤ ë‚´ì—ì„œ í˜¸ì¶œí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ í”„ë¡ì‹œ ì¸ìŠ¤í„´ìŠ¤ ë‚´ì—ì„œ í˜¸ì¶œí•˜ëŠ”ê²ƒì„ í™•ì¸í•˜ëŠ¥í•¨

### ì§€ì—°ì¡°íšŒ

```java
package hello.aop.internalcall;

import org.springframework.beans.factory.ObjectProvider;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.stereotype.Component;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Component
public class CallServiceV2 {
    // private final ApplicationContext applicationContext;
	private final ObjectProvider<CallServiceV2> callServiceV2ObjectProvider;

	public CallServiceV2(ObjectProvider<CallServiceV2> callServiceV2ObjectProvider) {
		this.callServiceV2ObjectProvider = callServiceV2ObjectProvider;
	}

	// public CallServiceV2(ApplicationContext applicationContext) {
	// 	this.applicationContext = applicationContext;
	// }

	public void external() {
        log.info("call external");
        CallServiceV2 callServiceV2 = callServiceV2ObjectProvider.getObject (CallServiceV2.class);
        callServiceV2.internal();
    }

    public void internal() {
        log.info("call internal");
    }
}

```

```java
package hello.aop.internalcall;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.annotation.Import;

import hello.aop.internalcall.aop.CallLogAspect;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Import(CallLogAspect.class)
@SpringBootTest
class CallServiceV2Test {
	@Autowired
	CallServiceV2 callServiceV2;

	@Test
	void external() {
		callServiceV2.external();
	}

}
```

ApplicationContextë¥¼ ì£¼ì„í•˜ê³  ObjectProvider< CallServiceV2 >ë¡œ ë³€ê²½í•œ ì´ìœ ëŠ” ApplicationContextì˜ ê¸°ëŠ¥ì´ ë„ˆë¬´ ë§ê¸°ë•Œë¬¸ì„

ObjectProviderëŠ” ìŠ¤í”„ë§ì»¨í…Œì´ë„ˆì—ì„œ ì¡°íšŒí•˜ëŠ” ê²ƒì„ ìŠ¤í”„ë§ ë¹ˆ ìƒì„± ì‹œì ì´ ì•„ë‹Œ ì‹¤ì œ ê°ì²´ ì‚¬ìš©ì‹œì ìœ¼ë¡œ ì§€ì—°í•  ìˆ˜ ìˆìŒ

ê·¸ë ‡ê¸° ë•Œë¬¸ì— `callServiceV2ObjectProvider.getObject (CallServiceV2.class);` ë¥¼ í˜¸ì¶œí•˜ëŠ” ì‹œì ì— ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì—ì„œ ë¹ˆì„ ì¡°íšŒí•¨

ë˜í•œ ìê¸°ìì‹ ì„ ì£¼ì…ë°›ëŠ”ê²ƒì´ì•„ë‹ˆê¸°ë•Œë¬¸ì— ìˆœí™˜ì°¸ì¡°ë„ ë°œìƒí•˜ì§€ì•ŠìŒ

### êµ¬ì¡° ë³€ê²½

```java
package hello.aop.internalcall;

import org.springframework.beans.factory.ObjectProvider;
import org.springframework.stereotype.Component;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Component
@RequiredArgsConstructor
public class CallServiceV3 {
	private final InternalService internalService;

	public void external() {
        log.info("call external");
        internalService.internal();
    }
}

```

```java
package hello.aop.internalcall;

import org.springframework.stereotype.Component;
import org.springframework.stereotype.Service;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Component
public class InternalService {
	public void internal() {
		log.info("call internal");
	}
}

```

ì»¨íŠ¸ë¡¤ëŸ¬ ìì²´ë¥¼ ë¶„ë¦¬ì‹œì¼œë²„ë¦¼

```java
package hello.aop.internalcall;

import static org.junit.jupiter.api.Assertions.*;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.annotation.Import;

import hello.aop.internalcall.aop.CallLogAspect;
import lombok.extern.slf4j.Slf4j;

@SpringBootTest
@Slf4j
@Import(CallLogAspect.class)
class CallServiceV3Test {

	@Autowired
	CallServiceV3 callServiceV3;

	@Test
	void external() {
		callServiceV3.external();
	}
}
```

![images](/assets/images/high/IMG-20240909161736-2.png)

ë‚´ë¶€í˜¸ì¶œì´ë˜ì§€ì•Šë„ë¡ êµ¬ì¡°ìì²´ë¥¼ ë³€ê²½í•˜ì˜€ìœ¼ë‚˜ ê°€ëŠ¥í•œ ê²½ìš°ì—ë§Œ ì ìš©í•  ìˆ˜ ìˆìŒ

> [!NOTE]
> 
> ğŸ’¡ AOPëŠ” íŠ¸ëœì ì…˜ì´ë‚˜ ë¡œê·¸ì¶œë ¥ê¸°ëŠ¥ì—ì„œ ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ”ë° ë³´í†µ ì¸í„°í˜ì´ìŠ¤ì— ë©”ì„œë“œê°€ ë‚˜ì˜¬ ê·œëª¨ì— AOPë¥¼ ì ìš©í•˜ê²Œë¨
== public ë©”ì„œë“œì—ì„œ ì£¼ë¡œ ì‚¬ìš©í•˜ê²Œë¨. private ë‹¨ìœ„ì—ì„œëŠ” ì˜ ì‚¬ìš©í•˜ì§€ì•ŠìŒ
AOPì ìš©ì„ ìœ„í•´ private ë©”ì†Œë“œë¥¼ ì™¸ë¶€í´ë˜ìŠ¤ë¡œ ë³€ê²½í•˜ê±°ë‚˜ publicìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ì¼ì€ ê±°ì˜ì—†ìŒ. ìœ„ ì˜ˆì œì™€ê°™ì´ public ë©”ì†Œë“œì—ì„œ publicë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ëŠ”ê²½ìš° ë‚´ë¶€í˜¸ì¶œ ë¬¸ì œê°€ ì£¼ë¡œ ë°œìƒí•¨
