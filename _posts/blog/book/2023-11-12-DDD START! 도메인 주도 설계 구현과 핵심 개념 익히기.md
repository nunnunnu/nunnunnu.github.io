---
생성일: 2023-11-12
last_modified_at: 2023-11-20
category: 프로그래밍 방법
tags:
  - DDD
  - jpa
title: "[책] DDD START! 도메인 주도 설계 구현과 핵심 개념 익히기"
---
[책정보](https://m.yes24.com/Goods/Detail/27750871)
![images](/assets/images/book/Pastedimage20240910170430.png)

좋은 책이었으나 jpa나 이벤트같은 내용은 더 공부하고 정리하려함. 일단 모르는것중에서 몇개만 가볍게 정리함

# DIP

DIP는 잘못생각하면 인터페이스와 구현부를 분리하는 정도로 받아들여질수있다. 핵심은 고수준 모듈이 저수준 모듈에 의존하지않도록 하는것!

구현의 편리함은 DIP가 주는 다른 장점(변경의 유연함, 테스트가 쉬움)만큼 중요하기때문에 DIP의 장점을 해치지 않는 범위에서 응용/도메인 영역이 구현기술에 대한 의존을 가져가는것은 ok → 대표적인 예가 트랜잭션

### 트랜잭션

트랜잭션 범위는 작을수록 좋음. db테이블을 기준으로 한 트랜잭션이 여러 테이블을 수정하게되면 그만큼 성능을 떨러뜨림.

또한 한개의 트랜잭션범위에서는 한개의 애그리거트만 수정해야함. 두개이상의 애그리거트를 수정하면 트랜잭션 충돌이 발생할 가능성이 커짐

만약 한 트랜잭션에서 두개의 애그리거트를 수정해야하는 경우가 생긴다면 응용서비스에서 두 애그리거트를 수정하도록 해야함

- 한 트랜잭션에서 두개의 애그리거트를 수정하는 경우
    - 팀 표준 : 팀이나 조직의 표준에따라 사용자 유스케이스와 관련된 응용서비스의 기능을 한 트랜잭션으로 실행해야하는 경우가 있음. DB가 다른경우 글로벌 트랜잭션을 반드시 사용하도록 규칙을 정하기도함
    - 기술제약 : 한 트랙잭션에서 두개이상의 애그리거트를 수정하는 대신 도메인 이벤트와 비동기를 사용하는 방식을 사용하는데 기술적으로 이벤트, 비동기를 사용할 수 없는 경우
    - UI구현의 편리 : 운영의 편리함을 위해 주문목록화면에서 여러 주문의 상태를 한번에 변경하고싶은경우

# 잠금

## 선전잠금

선전 잠금 방식으로 애그리거트를 구한경우 선요청상태의 스레드가 잠금을 해제할때까지 후요청 상태의 스레드는 대기상태가됨. → 교착상태 우려. 사용자가 많을수록 발생할 확률이 높음

⇒ 최대 대기시간을 지정하여 대기시간이 길어지면 exception 발생

## 비선점 잠금

운영자가 고객 배송지 조회 → 사용자가 배송지 변경 → 운영자가 사용자의 배송상태 변경

순으로 요청이 들어왔다면 배송은 배송지 변경 전 주소로됨.

⇒ 변경하려는 애그리거트가 이미 변경됐다면 비선전 잠금을 이용해 커밋을 실패시킴

jpa는 버전을 이용한 비선점 잠금 기능을 지원하는데 @version어노테이션을 붙이고 매핑데이터테이블에 버전컬럼을 추가하면된다

만약 버전이 10인상태에서 사용자 1과 사용자2가 동시 수정해서 사용자 1의 요청이 먼저 반영되어 버전이 11이 되었다면? 사용자 2의 버전은 10인상태에서 현재 db와 버전이 일치하는지 확인함 → 버전이 일치하지않는다면 OptimisticLockingFailureException이 발생됨

이런경우 메세지로 다른사용자가 수정중이라는 메세지를 띄운다면 해결됨!