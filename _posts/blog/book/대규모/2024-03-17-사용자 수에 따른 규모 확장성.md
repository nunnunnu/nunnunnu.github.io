---
title: "[책] 가상 면접 사례로 배우는 대규모 시스템 설계 기초 - 1장 사용자 수에 따른 규모 확장성"
last_modified_at: 2024-03-17
publish_date: 2024-03-17T14:17:00
category: 프로그래밍 방법
tags:
  - 설계
  - 가상면접사례로배우는대규모시스템설계기초
---

[책정보](https://m.yes24.com/Goods/Detail/102819435)
![images](/assets/images/대규모/IMG-20240910172136.png)
#### 웹 계층과 데이터 계층
![images](/assets/images/대규모/IMG-20240910172136-1.png)
웹 서버와 데이터베이스의 서버가 각각 1개씩인 구조
여기서 서버를 확장(스케일업)한다는 것은 수직적 규모 확장, 수평적 규모 확장 2가지로 나뉜다
- 수직적 규모 확장(vertical scaling) : 고사향자원을 추가하는 행위
	- 한계가 있음. 한대의 서버에 CPU나 메모리를 무한대로 증설할 수는 없음
	- 장애에대한 자동복구(failover) 방안이나 다중화(re-dundancy) 방안을 제시하지 않음 -> 서버 장애 시 웹사이트/앱이 완전 중단
- 수평적 규모 확장(scale out) : 서버를 추가해 성능을 개선하는 행위
	![images](/assets/images/대규모/IMG-20240910172137.png)
	- 대규모 애플리케이션을 지원할때 적절한 방법
	- 로드밸런서
		- 분산 집합에 속한 웹 서버들에게 트레픽 부하를 올바르게 분산
		1. 사용자가 공개 IP주소로 접근
		2. 로드밸런서가 사설IP주소(같은 네트워크에 속한 서버사이의 통신에만 쓰이기때문에 인터넷을 통해 접속 불가)로 웹 서버 접속
		- 서버 1이 다운돼면 모든 트래픽이 서버 2로 전송
		- 트래픽 증기 시 서버 추가로 대처 가능
	- 부하분산기
	- 데이터베이스 다중화
		- 보통 서버사이에 주(master) - 부(slave) 관계를 설정해 원본은 주 서버에, 사본은 부서버에 저장하는 방식
		- 쓰기연산은 master, slave는 읽기연산만
		- 디비 서버 분산의로 병렬로 처리될 수 있는 쿼리가 늘어나 성능 향상
		- db서버 중 하나가 파괴되어도 다중화된 디비로 데이터 보존 가능
		- 여러지역에 데이터를 복제하여 하나의 서버에 장애가 발생해도 다른 서버의 db사용가능
			- 부 데이터베이스가 한개인데 서버 다운 -> 읽기 연산이 한시적으로 주 db로 몰렸다가 새로운 부 데이터베이스 생성 시 대체됨
			- 주 데이터베이스가 다운 -> 부 데이터베이스 중 1개가 주 데이터베이스로 변경, 필요 시 부 데이터베이스 이후 생성
			  프로덕션 환경에서는 부 서버에 보관된 데이터가 최신 상태가 아닐 수 있어 없는 데이터는 복구 스크립트를 돌려 추가함. 다중 마스터나 원형 다중화 방식을 도입하면 도움이 되나 너무 복잡하여 책에서는 다루지않음
		  
#### 응답시간
##### 캐시
캐시에 값이 있으면 캐시를 반환, 없으면 DB에서 조회하는 전략을 **주도형 캐시 전략**이라고 한다
단 캐시를 사용하게된다면 고려해야할 사항이 많다
- 데이터 갱신이 자주 일어나지않지만 참조가 많이발생한다면 고려
- 영구보관할 데이터는 캐시가 아닌 지속적 저장소에 저장해야함
- 만료방법, 만료시간 지정(지정하지않으면 캐시에 데이터가 계속 남음 + 만료시간이 너무 짧으면 db를 자주읽어서 효과가 떨어짐)
- 일관성 유지방법. db와 캐시의 사본이 다를경우. 원본 데이터 갱신 시 캐시도 갱신해야함(단일트랜젝션으로 묶여야함)
- 장애 대처 방법 : 서버와 db서버를 다중화 해도 캐시 서버가 단일서버라면 캐시서버가 단일장애지점(Single Point Of Failure : SPOF, 특정 지점의 장애가 전체 시스템의 동작을 중단시킬수도 있음)이 되어버릴수도있음
- 캐시메모리는 얼마나 크게잡을것인가? 캐시가 저장될 메모리가 작다면 데이터가 너무 자주 캐시에서 밀려나가게됨
- 데이터 방출정책 : 캐시 메모리가 꽉찼을경우 기존 데이터는 어떤기준으로 삭제할것인가?
	- LRU : 가장오래 사용하지않은 데이터 삭제
	- LFU : 사용빈도가 가장 적은 데이터 삭제
	- FIFO : 선입선출
##### CDN
정적 콘텐츠를 전송하는데 쓰이는 지리적으로 분산된 서버의 네트워크. 이미지, 비디오, css, javaScript 파일 등을 캐시
요청경로, query string, 쿠키, 요청헤더 등의 정보로 HTML콘텐츠를 캐시하는 방법
사용자에게 가장 가까운 CDN서버에서 정적 콘텐츠를 가져옴(없으면 원본서버에서[웹orS3])
CDN서버로부터 멀면 멀수록 느림
응답 http 헤더에는 파일이 얼마나 오래 캐시될수있는지를 설명하는 TTL(Time To Live)값이 들어있는데 해당 시간이 끝날때까지 캐시된다
- 비용 : 보통 제 3사업자에 의해 운영되며 CDN으로 들어가고 나가는 데이터 전송량에따라 비용을 지불함. 이득이 크지않다면 사용하지않아도 무방함
- 만료시한 : 시의성이 중요한 콘텐츠일 경우 만료시점을 잘 정의해야함. 너무 길지도, 짧지도 않아야하는데 너무길면 콘텐츠의 신선도가 떨어지고 짧으면 원본서버에 너무 빈번히 접속하게됨
- CDN 장애 대처 : CDN이 죽었을때 웹/어플리케이션이 어떻게 동작해야하는지? 원본서버에서 직접 가져오도록 구성하는것이 필요할수도있음
- 콘텐츠 무효화 : 아직 만료되자않았어도 무효화
	- CDN 사업자가 제공하는 API
	- 콘텐츠의 다른 버전을 서비스하도록 오브젝트 버저닝을 이용(url마지막 인자에 버전정보를 인자로 줌)
![images](/assets/images/대규모/IMG-20240910172137-1.png)

#### 무상태 웹 계층
웹 계층에서 제거하고 상태정보(사용자 세션 데이터 등)를 제거하고 RDBMS나 NoSQL에 저장하는방법
서버가 여러개다보니 상태정보를 웹서버에 저장하게되면 A서버에있는 상태정보가 B서버에 없어서 생기는 문제임
사용자 A의 요청은 전부 A서버로 전송되어야하는데 로드밸런서가 이를 지원하기위해 고정 세션이라는 기능을 제공하고있기는 하지만 로드밸런서에 부담을 줄 수 있고 로드밸런서 뒷단에 서버를 추가하거나 제거하기도 까다로워짐
![images](/assets/images/대규모/IMG-20240910172137-2.png)
편의상 NoSQL로 적었는데 관계형데이터베이스, redis 등도 가능하다
#### 데이터 센터
장애가 없는 상황에서 사용자는 가장 가까운 데이터 센터로 안내됨. 이 절차를 통산 **지리적라우팅**이라고 부름
![images](/assets/images/대규모/IMG-20240910172137-3.png)
만약 데이터센터 중 하나가 장애가 발생하면 모든 트래픽이 다른 데이터서버로 전송됨
- 트래픽 우회 : 올바른 데이터 센터로 트래필을 보내는 효과적인 방법을 찾아야함. GeoDNS는 가장 가까운 데이터 센터로 트래픽을 보낼 수 있어야함
- 데이터 동기화 : 데이터 센터마다 데이터베이스의 정보가 다를때 한 데이터센터가 장애가 발생하여 우회한다고해도 해당 데이터센터에 찾는 데이터가 없을수도있음
  보편적으로 데이터를 여러 데이터센터에 걸쳐 다중화함
- 메세지 큐
	- 무손실을 보장하는 비동기 통신 지원 컴포넌트
	- 메세지의 버퍼역할을 함
	- 생산자/발행자라 불리는 입력서비스가 메세지를 만들어 메세지큐에 발행, 큐에는 소비자/구독자의 서비스/서버가 연결되어있는데 메세지를 받아 그에 맞는 동작을 수행함
	- 서비스, 서버간의 결합이 느슨해져서 규모확장성이 보장되어야하는 안정적인 애플리케이션을 구성하기 좋음
	- 사진보정애플리케이션의 보정작업은 시간이 걸릴수도있는 프로세스이기때문에 비동기를 활용하면 좋음
#### 로그, 메트릭 그리고 자동화
###### 로그
에러 모니터링을 위해 사용
###### 메트릭
사업현황에 유용한 정보를 얻을 수 있음
- 호스트 단위 메트릭 : CPU, 메모리, 디스트I/O에 관한 메트릭이 여기 해당
- 종합 메트릭 : 데이터베이스 계층의 성능, 캐시계층의 성능
- 핵심 비즈니스 메트릭 : 일별 능동 사용자, 수익, 재방문같은 것이 여기 해당
###### 자동화
지속적 통합을 도와주는 도구를 사용하면 개발자가 만드는 코드가 어떤 검증절차를 자동으로 거치도록 할수있어 문제감지에 용이함
![images](/assets/images/대규모/IMG-20240910172137-4.png)
#### 데이터 베이스의 수평적 확장(**샤딩**)
서버를 추가해서 성능을 확장시키는 방법
데이터베이스를 **샤드**라고 부르는 작은 단위로 분할
같은 스키마를 쓰지만 샤드에 보관되는 데이터사이에 중복은 없음
어느 샤드에 데이터를 저장할지는 PK에 따라 정함
<mark style="background: #ABF7F7A6;">가장중요한것은 샤딩 키를 어떻게 정하느냐임</mark>
- 데이터 재 샤딩 : 데이터가 많아져 하나의 샤드로 감당불가할때 or 샤드간 데이터 분포 불균등(샤드소진)
  5장의 안정 해시방법으로 해결가능
- 유명인사 문제 : 한 샤드에 많이조회되는 key가 몰려있어 한 샤드에 접속이 집중됨
- 조인, 비정규화 : 하나의 db를 여러 사드로 쪼개면 조인이 불가능해지는 문제발생 -> 데이터베이스 비정규화
